name: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º

on:
  workflow_dispatch:
    inputs:
      action:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º'
        required: true
        default: 'restart'
        type: choice
        options:
        - restart
        - start
        - stop

jobs:
  control:
    runs-on: self-hosted

    steps:
    - name: –í—ã–ø–æ–ª–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
      run: |
        ACTION="${{ inputs.action }}"

        case $ACTION in
          "start")
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
            cd workspace/hackathon

            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å..."
            docker-compose ps

            echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose up -d

            echo "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞..."
            sleep 3

            # –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥
            MAX_ATTEMPTS=10

            for i in $(seq 1 $MAX_ATTEMPTS); do
              if docker-compose ps | grep -q "Up"; then
                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_ATTEMPTS)"

                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Python –ø—Ä–æ—Ü–µ—Å—Å–∞
                if docker-compose exec -T publichun-bot pgrep -f "python.*main.py" > /dev/null 2>&1; then
                  echo "‚úÖ –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤!"
                  break
                fi
              fi

              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
                docker-compose logs publichun-bot || true
                exit 1
              fi

              echo "‚è≥ –ñ–¥–µ–º –µ—â–µ 3 —Å–µ–∫—É–Ω–¥—ã..."
              sleep 3
            done

            echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
            docker-compose ps
            ;;
          "stop")
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞..."
            cd workspace/hackathon

            echo "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:"
            docker-compose ps

            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down

            echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            ;;
          "restart")
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
            cd workspace/hackathon

            echo "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:"
            docker-compose ps

            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down

            echo "‚è≥ –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞..."
            sleep 3

            echo "–°–æ–±–∏—Ä–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker-compose build --parallel

            echo "–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose up -d

            echo "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
            sleep 3

            # –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 45 —Å–µ–∫—É–Ω–¥
            MAX_ATTEMPTS=15

            for i in $(seq 1 $MAX_ATTEMPTS); do
              if docker-compose ps | grep -q "Up"; then
                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_ATTEMPTS)"

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Python –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
                if docker-compose exec -T publichun-bot pgrep -f "python.*main.py" > /dev/null 2>&1; then
                  echo "‚úÖ –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!"
                  break
                fi
              fi

              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"
                echo "üìù –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞:"
                docker-compose logs --tail=20 publichun-bot || true
                exit 1
              fi

              echo "‚è≥ –ñ–¥–µ–º –µ—â–µ 3 —Å–µ–∫—É–Ω–¥—ã..."
              sleep 3
            done

            echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
            docker-compose ps
            ;;
          *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: $ACTION"
            echo "–î–æ–ø—É—Å—Ç–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: start, stop, restart"
            exit 1
            ;;
        esac
