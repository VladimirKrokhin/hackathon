name: Управление ботом

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Выберите действие'
        required: true
        default: 'restart'
        type: choice
        options:
        - restart
        - start
        - stop

jobs:
  control:
    runs-on: self-hosted
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      YANDEXGPT_API_KEY: ${{ secrets.YANDEXGPT_API_KEY }}
      YANDEXGPT_CATALOG_ID: ${{ secrets.YANDEXGPT_CATALOG_ID }}
      FUSION_BRAIN_API_KEY: ${{ secrets.FUSION_BRAIN_API_KEY }}
      FUSION_BRAIN_SECRET_KEY: ${{ secrets.FUSION_BRAIN_SECRET_KEY }}
      DEBUG: ${{ secrets.DEBUG }}

    steps:
    - name: Выполняем действие
      shell: bash
      run: |
        # Экспортируем GitHub secrets и выполняем команду в одном shell
        export BOT_TOKEN="${BOT_TOKEN}"
        export YANDEXGPT_API_KEY="${YANDEXGPT_API_KEY}"
        export YANDEXGPT_CATALOG_ID="${YANDEXGPT_CATALOG_ID}"
        export FUSION_BRAIN_API_KEY="${FUSION_BRAIN_API_KEY}"
        export FUSION_BRAIN_SECRET_KEY="${FUSION_BRAIN_SECRET_KEY}"
        export DEBUG="${DEBUG}"

        case "${{ inputs.action }}" in
          "start")
            docker compose up -d
            echo "Бот запущен"
            ;;
          "stop")
            docker compose down
            echo "Бот остановлен"
            ;;
          "restart")
            docker compose down
            docker compose up --build -d
            echo "Бот перезапущен"
            ;;
        esac
