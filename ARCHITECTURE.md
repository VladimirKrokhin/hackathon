# Архитектура проекта

## Обзор

Проект представляет собой Telegram-бот для генерации контента для некоммерческих организаций (НКО). Бот предоставляет функциональность:

- Генерация текстового контента с использованием YandexGPT
- Генерация изображений через FusionBrain API
- Генерация контент-карточек (PIL + Playwright)
- Создание и управление контент-планами с автоматическими напоминаниями
- Редактирование текста через AI

Архитектура основана на принципах Clean Architecture с разделением на слои и dependency injection.

## Структура проекта

```
src/
├── main.py              # Точка входа приложения
├── bootstrap.py         # Инициализация сервисов и зависимостей
├── config.py            # Конфигурация приложения
├── service_bus.py       # Управление жизненным циклом сервисов
├── models.py            # Доменные модели данных
├── dtos.py              # Data Transfer Objects
├── bot/                 # Слой обработки Telegram API
├── services/            # Бизнес-логика сервисов
└── infrastructure/      # Инфраструктурные компоненты
```

## Основные слои

### Доменные модели (models.py, dtos.py)

**models.py** содержит основные сущности:
- `Ngo` - информация о некоммерческой организации
- `ContentPlan` - контент-планы пользователей
- `ContentPlanItem` - элементы контент-плана с датами публикаций
- `PublicationStatus` - статусы публикаций (запланировано/опубликовано/просрочено)

**dtos.py** содержит структуры данных для передачи:
- `PromptContext` - контекст для генерации промптов
- `PlanPromptContext` - контекст для планирования контента
- `EditPromptContext` - контекст для редактирования текста
- `CardData` - данные для генерации карточек

### Слой сервисов (services/)

Сервисы реализуют основную бизнес-логику и оркестрируют работу инфраструктурных компонентов:

- `NGOService` - управление данными НКО
- `TextGenerationService` - генерация текстового контента
- `CardGenerationService` - генерация контент-карточек
- `ImageGenerationService` - генерация изображений
- `ContentPlanService` - управление контент-планами
- `NotificationService` - отправка уведомлений о публикациях

**Изменение/добавление в сервисном слое:**
- Создать новый класс сервиса в `src/services/`
- Если сервис используется в приложении, добавить сервис в `bootstrap.py.build_and_bind_services()`, зарегистрировать сервис в dispatcher для dependency injection, привязать к событиям запуска и остановки приложения через service_bus, если сервис требует "тяжелой" настройки (подключение к БД, подъем окружения, запуск сущности...)
- Обновить связи с инфраструктурными компонентами

### Инфраструктурный слой (infrastructure/)

Содержит компоненты для взаимодействия с внешними системами:

**Репозитории (`repositories/`):**
- `SqlAlchemyNgoRepository` - работа с данными НКО
- `SqlAlchemyContentPlanRepository` - работа с контент-планами

**API клиенты:**
- `YandexGPT` - клиент для YandexGPT API
- `FusionBrainImageGenerator` - клиент для генерации изображений
- `TelegramBotNotificator` - отправка уведомлений через Telegram

**Обработка данных:**
- `YandexGPTPromptBuilder` - построение промптов для YandexGPT
- `YandexGPTResponseProcessor` - обработка ответов YandexGPT
- `PillowCardGenerator` - генерация изображений карточек

**Вспомогательные компоненты:**
- `ContentPlanScheduler` - планировщик проверок контент-плана

**Изменение/добавление в инфраструктурном слое:**
- Создать абстрактный интерфейс (Abstract класс) в соответствующем модуле
- Реализовать конкретный класс наследующий абстракцию
- Добавить компонент в `bootstrap.py.build_and_bind_services()`, если используется в сервисе
- Зарегистрировать компонент в dispatcher для dependency injection
- Обновить `AbstractPromptBuilder`, `AbstractResponseProcessor` и другие интерфейсы при новых типах обработки

### Слой бота (bot/)

Обработчики Telegram взаимодействий:

**Основные компоненты:**
- `main_router.py` - главный роутер включающий все подроутеры
- `dispatcher` - глобальный экземпляр aiogram диспетчера

**Обработчики (`handlers/`):**
- `start.py` - главное меню и навигация
- `new_generation.py` - мастер создания контента
- `content_plan_generation.py` - создание контент-планов
- `content_plan_menu.py` - управление контент-планами
- `text_editing.py` - редактирование текста
- `image_generation.py` - генерация изображений
- `ngo_info.py` - управление информацией о НКО

**Состояния (`states.py`):**
- FSM состояния для многошаговых взаимодействий:
  - `ContentGeneration` - генерация контента
  - `ContentWizard` - мастер создания контента
  - `ContentPlan` - управление планами
  - `EditText` - редактирование текста
  - `NGOInfo` - информация о НКО
  - `ImageGeneration` - генерация изображений

**Изменение/добавление в бот-слое:**
- Создать новый роутер в `src/bot/handlers/`
- Добавить состояния в `src/bot/states.py` если нужны многошаговые взаимодействия
- Подключить роутер в `src/bot/main_router.py`, если создается новый роутер
- Использовать сервисы из dispatcher через dependency injection (получать от экземпляра dispatcher)
- Обновить главное меню в `src/bot/handlers/start.py` при добавлении новых функций

## Инициализация приложения

### Точка входа (main.py)
Запускает асинхронный цикл бота через aiogram и выполняет bootstrap.

### Bootstrap (bootstrap.py)
Отвечает за инициализацию всех компонентов:

**Функция `build_and_bind_services()`:**
- Инициализирует базу данных
- Создает экземпляры инфраструктурных компонентов
- Создает экземпляры сервисов
- Регистрирует все компоненты в dispatcher aiogram для dependency injection

**Добавление новых компонентов:**
- Добавить создание компонента в `build_and_bind_services()`
- Зарегистрировать в dispatcher под уникальным ключом
- Зарегистрировать startup/shutdown функции в service_bus при необходимости

### Service Bus (service_bus.py)
Управляет жизненным циклом сервисов:
- Регистрация startup и shutdown функций
- Последовательное выполнение при инициализации/остановке приложения

## Работа с данными

### Конфигурация (config.py)
Pydantic-based конфигурация через переменные окружения:
- Настройки Telegram бота
- Настройки YandexGPT API
- Настройки FusionBrain API
- Настройки приложения (таймауты, интервалы)

**Добавление новых настроек:**
- Добавить поля в класс Config
- Использовать Field с env параметром для переменных окружения
- Добавить валидацию в validate_config() при необходимости

### Репозитории
Реализуют паттерн Repository для абстракции доступа к данным:
- Абстрактные интерфейсы (Abstract*Repository)
- Конкретные реализации (SqlAlchemy*Repository)
- Преобразование между доменными моделями и ORM

**Изменение/добавление репозиториев:**
- Добавить новый Abstract класс с интерфейсом репозитория
- Реализовать конкретный класс
- Добавить методы преобразования моделей в DTO и обратно (желательно)
- Зарегистрировать в `bootstrap.py`


## Архитектурные принципы

### Dependency Injection
Компоненты не создают зависимости самостоятельно, а получают их из dispatcher.

### Абстракции
Инфраструктурные компоненты имеют абстрактные интерфейсы для возможности замены реализаций.

### FSM для сложных взаимодействий
Многошаговые сценарии реализованы через Finite State Machine aiogram.

### Асинхронная архитектура
Все операции ввода-вывода асинхронны через async/await.
