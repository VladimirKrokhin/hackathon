import logging
from config import config
from typing import Dict, List

logger = logging.getLogger(__name__)

class PromptBuilder:
    def build_prompt(self, user_data: Dict, user_text: str) -> str:
        goal = user_data.get('goal', '–æ–±—â–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ù–ö–û')
        audience = ', '.join(user_data.get('audience', ['–º–æ–ª–æ–¥–µ–∂—å']))
        platform = user_data.get('platform', '—Å–æ—Ü—Å–µ—Ç–∏')
        content_format = ', '.join(user_data.get('format', ['–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç']))
        volume = user_data.get('volume', '—Å—Ä–µ–¥–Ω–∏–π –ø–æ—Å—Ç')
        event_details = user_data.get('event_details', '')
        has_event = user_data.get('has_event', False)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –∏ —Ç–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
        audience_style = self._get_audience_style(audience)
        platform_requirements = self._get_platform_requirements(platform)
        
        # –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç
        prompt = f"""
        ### –ò–ù–°–¢–†–£–ö–¶–ò–Ø ###
        –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMM-–º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ù–ö–û. –°–æ–∑–¥–∞–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –Ω–∏–∂–µ.

        ### –ö–õ–Æ–ß–ï–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø ###
        1. –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∏–ª–µ: "{audience_style}"
        2. –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å: "{goal}"
        3. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {audience}
        4. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {platform} ({platform_requirements})
        5. –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_format}
        6. –û–±—ä–µ–º: {volume}
        7. –í–∞–∂–Ω–æ: –≠—Ç–æ –ù–ö–û –≤ –∑–∞–∫—Ä—ã—Ç–æ–º –≥–æ—Ä–æ–¥–µ. –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–π —Ä–µ–∂–∏–º–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –≤–æ–µ–Ω–Ω—ã–µ –±–∞–∑—ã –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –º–∏—Å—Å–∏–∏ –∏ –ø–æ–º–æ—â–∏ –ª—é–¥—è–º.
        8. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏: –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏ –∏ –ø—Ä–∏–∑—ã–≤ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é.

        ### –ö–û–ù–¢–ï–ö–°–¢ ###
        {self._get_event_context(has_event, event_details)}

        ### –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ###
        {user_text}

        ### –ü–†–ò–ú–ï–†–´ –£–°–ü–ï–®–ù–´–• –ü–û–°–¢–û–í –î–õ–Ø –ù–ö–û ###
        ‚Ä¢ "üåü –î—Ä—É–∑—å—è, –Ω–∞–º –Ω—É–∂–Ω—ã –≤–æ–ª–æ–Ω—Ç–µ—Ä—ã! –ü–æ–º–æ–≥–∏—Ç–µ –¥–µ—Ç—è–º –∏–∑ –º–Ω–æ–≥–æ–¥–µ—Ç–Ω—ã—Ö —Å–µ–º–µ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —à–∫–æ–ª–µ. –í–∞—à–µ —É—á–∞—Å—Ç–∏–µ –∏–∑–º–µ–Ω–∏—Ç –∂–∏–∑–Ω–∏ —ç—Ç–∏—Ö –¥–µ—Ç–µ–π!"
        ‚Ä¢ "üí° –í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∞–∂–Ω–∞! –ë–ª–∞–≥–æ–¥–∞—Ä—è –≤–∞–º –º—ã —Å–æ–±—Ä–∞–ª–∏ 100 –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ —à–∫–æ–ª—å–Ω—ã—Ö –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –¥–µ—Ç–µ–π –Ω–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞."
        ‚Ä¢ "üéâ –ü—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ü–µ—Ä—Ç! 15 –¥–µ–∫–∞–±—Ä—è –≤ –î–ö ¬´–†–æ–¥–∏–Ω–∞¬ª. –í—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–π–¥—É—Ç –Ω–∞ —Ä–µ–º–æ–Ω—Ç –¥–µ—Ç—Å–∫–æ–π –ø–ª–æ—â–∞–¥–∫–∏."

        ### –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê ###
        –¢–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
        """
        return prompt.strip()
    
    def _get_audience_style(self, audience_str: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏"""
        audience_str = audience_str.lower()
        
        if "–º–æ–ª–æ–¥–µ–∂—å" in audience_str or "14-25" in audience_str or "—Å—Ç—É–¥–µ–Ω—Ç—ã" in audience_str:
            return "–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π, —Å —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ –∞–±–∑–∞—Ü–µ–≤, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–µ–Ω–≥"
        elif "—Å–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏" in audience_str or "—Ä–æ–¥–∏—Ç–µ–ª–∏" in audience_str:
            return "—Ç–µ–ø–ª—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –±–µ–∑ –∂–∞—Ä–≥–æ–Ω–∞, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å–µ–º–µ–π–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏"
        elif "–±–∏–∑–Ω–µ—Å" in audience_str or "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" in audience_str or "–∫–æ–º–ø–∞–Ω–∏–∏" in audience_str:
            return "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å–æ—Ü–∏–∞–ª—å–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, ROI"
        elif "–ø–æ–∂–∏–ª—ã–µ" in audience_str or "45+" in audience_str or "—Å—Ç–∞—Ä—à–µ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ" in audience_str:
            return "—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∑–∞–±–æ—Ç—É"
        else:
            return "—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π"
    
    def _get_platform_requirements(self, platform: str) -> str:
        """–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º"""
        platform = platform.lower()
        
        if "–≤–∫–æ–Ω—Ç–∞–∫—Ç–µ" in platform or "vk" in platform or "–≤–∫" in platform:
            return "–ò—Å–ø–æ–ª—å–∑—É–π 3-5 —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç–µ, –¥–æ–±–∞–≤—å 3-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ, —Ä–∞–∑–±–µ–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
        elif "telegram" in platform or "—Ç–µ–ª–µ–≥—Ä–∞–º" in platform or "tg" in platform:
            return "–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, --- –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π, –¥–æ–±–∞–≤—å 1-2 –∫–ª—é—á–µ–≤—ã—Ö —Ö–µ—à—Ç–µ–≥–∞, –º–∏–Ω–∏–º—É–º —ç–º–æ–¥–∑–∏"
        elif "instagram" in platform or "–∏–Ω—Å—Ç–∞–≥—Ä–∞–º" in platform or "insta" in platform:
            return "–ö–æ—Ä–æ—Ç–∫–∏–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ú–∞–∫—Å–∏–º—É–º 2200 —Å–∏–º–≤–æ–ª–æ–≤. –î–æ–±–∞–≤—å 5-10 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ"
        elif "—Å–∞–π—Ç" in platform or "–Ω–æ–≤–æ—Å—Ç–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞" in platform:
            return "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å, –ø–æ–ª–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ —ç–º–æ–¥–∑–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ç–µ–∫—Å—Ç–µ"
        else:
            return "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π"
    
    def _get_event_context(self, has_event: bool, event_details: str) -> str:
        """–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏"""
        if not has_event or not event_details:
            return ""
        
        return f"""
### –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ò ###
{event_details}

### –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –£–ü–û–ú–ò–ù–ê–ù–ò–Æ –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ###
‚Ä¢ –£–∫–∞–∂–∏ —Ç–æ—á–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
‚Ä¢ –£–∫–∞–∂–∏ –º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (–±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–µ–∂–∏–º–Ω—ã—Ö –∑–æ–Ω)
‚Ä¢ –û–±—ä—è—Å–Ω–∏, –∑–∞—á–µ–º –Ω—É–∂–Ω–æ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
‚Ä¢ –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏
‚Ä¢ –£–∫–∞–∂–∏, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∏
‚Ä¢ –î–æ–±–∞–≤—å —Å—Ä–æ—á–Ω—ã–π –ø—Ä–∏–∑—ã–≤ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ–¥–ª–∞–π–Ω)
"""